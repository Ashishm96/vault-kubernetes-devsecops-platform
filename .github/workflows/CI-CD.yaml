name: Deploy HashiCorp Vault to Minikube (CI/CD Pipeline)

on:
  push:
    branches:
      - main

jobs:

  validate:
    runs-on: self-hosted
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Verify Podman Access
        run: podman --version

      - name: Check Helm and Kubectl Versions
        run: |
          kubectl version --client
          helm version


  build:
    runs-on: self-hosted
    needs: validate
    env:
      JFROG_REGISTRY: "trialp14fhd.jfrog.io"
      JFROG_REPO: "vault-repo"
      IMAGE_NAME: "vault-server"
      IMAGE_TAG: "${{ github.run_number }}-$(date +'%Y%m%d')"
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Build Image with Podman
        run: |
          set -e
          echo "Building image using Podman..."
          podman build \
            -t $JFROG_REGISTRY/$JFROG_REPO/$IMAGE_NAME:$IMAGE_TAG \
            -f docker/Dockerfile .


  push:
    runs-on: self-hosted
    needs: build
    env:
      JFROG_REGISTRY: "trialp14fhd.jfrog.io"
      JFROG_REPO: "vault-repo"
      IMAGE_NAME: "vault-server"
      IMAGE_TAG: "${{ github.run_number }}-$(date +'%Y%m%d')"
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Login to JFrog using Podman
        run: |
          echo "${{ secrets.JFROG_PASSWORD }}" | \
          podman login $JFROG_REGISTRY \
            --username "${{ secrets.JFROG_USERNAME }}" \
            --password-stdin

      - name: Push Image to JFrog
        run: |
          echo "Pushing image to JFrog..."
          podman push \
            $JFROG_REGISTRY/$JFROG_REPO/$IMAGE_NAME:$IMAGE_TAG


  vulnerability_check:
    runs-on: self-hosted
    needs: push
    env:
      JFROG_REGISTRY: "trialp14fhd.jfrog.io"
      JFROG_REPO: "vault-repo"
      IMAGE_NAME: "vault-server"
      IMAGE_TAG: "${{ github.run_number }}-$(date +'%Y%m%d')"
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Run Trivy Scan (Registry Image)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.JFROG_REGISTRY }}/${{ env.JFROG_REPO }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          format: table
          output: trivy-report.txt
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'HIGH,CRITICAL'
        continue-on-error: true

      - name: Upload Trivy Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-report.txt


  deploy:
    runs-on: self-hosted
    needs: vulnerability_check
    env:
      JFROG_REGISTRY: "trialp14fhd.jfrog.io"
      JFROG_REPO: "vault-repo"
      IMAGE_NAME: "vault-server"
      IMAGE_TAG: "${{ github.run_number }}-$(date +'%Y%m%d')"
      K8S_NAMESPACE: "vault-deployment"
      K8S_DEPLOYMENT_NAME: "vault"
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Create Namespace if Not Exists
        run: |
          kubectl get namespace $K8S_NAMESPACE || \
          kubectl create namespace $K8S_NAMESPACE

      - name: Lint Helm Chart
        run: helm lint ./helm

      - name: Helm Dry Run
        run: |
          helm upgrade --install vault ./helm \
            --namespace $K8S_NAMESPACE \
            --set image.repository=$JFROG_REGISTRY/$JFROG_REPO/$IMAGE_NAME \
            --set image.tag=$IMAGE_TAG \
            --set server.ha.enabled=true \
            --dry-run

      - name: Install / Upgrade Vault
        run: |
          helm upgrade --install vault ./helm \
            --namespace $K8S_NAMESPACE \
            --set image.repository=$JFROG_REGISTRY/$JFROG_REPO/$IMAGE_NAME \
            --set image.tag=$IMAGE_TAG \
            --set imagePullSecrets[0].name=jfrog-registry-secret \
            --set server.ha.enabled=true \
            --create-namespace \
            --wait --timeout 300s

      - name: Verify Deployment
        run: |
          kubectl get all -n $K8S_NAMESPACE
          kubectl describe deployment/$K8S_DEPLOYMENT_NAME -n $K8S_NAMESPACE

      - name: Verify Vault Health
        run: |
          kubectl port-forward svc/vault -n $K8S_NAMESPACE 8200:8200 &
          PID=$!
          sleep 5
          curl -k http://localhost:8200/v1/sys/health || true
          kill $PID

      - name: Rollback on Failure
        if: failure()
        run: |
          helm rollback vault -n $K8S_NAMESPACE || true


  monitoring:
    runs-on: self-hosted
    needs: deploy
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Install Prometheus
        run: |
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo update
          helm upgrade --install prometheus prometheus-community/prometheus \
            -n monitoring --create-namespace \
            -f ./helm/monitoring/prometheus-values.yaml

      - name: Install Grafana
        run: |
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo update
          helm upgrade --install grafana grafana/grafana \
            -n monitoring \
            -f ./helm/monitoring/grafana-values.yaml


  cleanup:
    runs-on: self-hosted
    needs: monitoring
    env:
      JFROG_REGISTRY: "trialp14fhd.jfrog.io"
      JFROG_REPO: "vault-repo"
      IMAGE_NAME: "vault-server"
    steps:
      - name: Delete Old Images from JFrog
        run: |
          curl -u "${{ secrets.JFROG_USERNAME }}:${{ secrets.JFROG_PASSWORD }}" \
          -X DELETE \
          "https://$JFROG_REGISTRY/artifactory/api/docker/$JFROG_REPO/v2/$IMAGE_NAME/tags?olderThan=3d"


  notify:
    runs-on: self-hosted
    needs: [validate, build, push, vulnerability_check, deploy, monitoring, cleanup]
    steps:
      - name: Notify Slack on Success
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"Vault deployment succeeded for run #${{ github.run_number }}."}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on Failure
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"Vault deployment failed for run #${{ github.run_number }}. Check logs."}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}
